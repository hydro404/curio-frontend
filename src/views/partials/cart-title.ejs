<!-- Page Title-->
<div class="page-title-overlap bg-dark pt-4">
  <div class="container d-lg-flex justify-content-between py-2 py-lg-3">
    <div class="order-lg-2 mb-3 mb-lg-0 pt-lg-2">
      <nav aria-label="breadcrumb">
        <ol
          class="breadcrumb breadcrumb-light flex-lg-nowrap justify-content-center justify-content-lg-start"
        >
          <li class="breadcrumb-item">
            <a class="text-nowrap" href="/"
              ><i class="ci-home"></i>Home</a
            >
          </li>
          <li class="breadcrumb-item text-nowrap">
            <a href="/products">Shop</a>
          </li>
          <li class="breadcrumb-item text-nowrap active" aria-current="page">
            Cart
          </li>
        </ol>
      </nav>
    </div>
    <div class="order-lg-1 pe-lg-4 text-center text-lg-start">
      <h1 class="h3 text-light mb-0">Your cart</h1>
    </div>
  </div>
</div>
<div class="container pb-5 mb-2 mb-md-4">
  <div class="row">
    <!-- List of items-->
    <section class="col-lg-8">
      <div
        class="d-flex justify-content-between align-items-center pt-3 pb-4 pb-sm-5 mt-1"
      >
        <h2 class="h6 text-light mb-0">Products</h2>
        <a class="btn btn-outline-primary btn-sm ps-2" href="/products"
          ><i class="ci-arrow-left me-2"></i>Continue shopping</a
        >
      </div>
      <!-- Item-->
      <% cartItems.forEach(function(item, index) { %>
        <!-- Cart item -->
        <div class="d-sm-flex justify-content-between align-items-center my-2 pb-3 border-bottom">
          <!-- Product details -->
          <div class="d-block d-sm-flex align-items-center text-center text-sm-start">
            <a class="d-inline-block flex-shrink-0 mx-auto me-sm-4" href="/product?id=<%= item.id %>">
              <% var images = item.images[0]; %>
              <img src="img/<%- images.path %>" width="160" alt="<%= item.name %>">
            </a>
            <div class="pt-2">
              <h3 class="product-title fs-base mb-2">
                <a href="/product?id=<%= item.id %>"><%= item.name %></a>
              </h3>
              <div class="fs-sm">
                <span class="text-muted me-2">Variation:</span><%= item.variation %>
              </div>
              <div class="fs-lg text-accent pt-2"><span class="text-accent">&#8369;<%- item.price%></span></div>
            </div>
          </div>
          <!-- Quantity and remove button -->
          <div class="pt-2 pt-sm-0 ps-sm-3 mx-auto mx-sm-0 text-center text-sm-start" style="max-width: 9rem">
            <label class="form-label" for="quantity_<%= index %>">Quantity</label>
            <input class="form-control" type="number" id="quantity_<%= index %>" min="1" value="<%= item.quantity %>">
            <button class="btn btn-link px-0 text-danger" type="button" onclick="removefromCart(<%= item.id %>)">
              <i class="ci-close-circle me-2"></i>
              <span class="fs-sm">Remove</span>
            </button>
          </div>
        </div>
      <% }); %>
      <!-- Buttons-->
      <button class="btn btn-outline-accent d-block w-100 mt-4" type="button" onclick="updateCart()">
        <i class="ci-loading fs-base me-2"></i>Update cart
      </button>
    </section>
    <!-- Sidebar-->
    <aside class="col-lg-4 pt-4 pt-lg-0 ps-xl-5">
      <div class="bg-white rounded-3 shadow-lg p-4">
        <div class="py-2 px-xl-2">
          <div class="text-center mb-4 pb-3 border-bottom">
            <ul class="list-group list-group-flush">
              <% cartItems.forEach(function(item) { %>
                <li class="list-group-item border-bottom-0">
                <span class="text-start me-2 pb-4 pe-5"><%= item.quantity  %> x <%= item.name %></span>
                <span class="text-muted text-end me-2 pb-4 ">&#8369;<%= (item.quantity  * item.price).toFixed(2) %></span>
              </li><% }); %>
            </ul>
            
          </div>
          <div class="text-center mb-4 pb-3 border-bottom">
            <%
              let grandTotal = 0;
              cartItems.forEach(function(item) {
                grandTotal += item.quantity  * item.price;
              });
            %>
            <h2 class="h6 mb-3 pb-1">Subtotal</h2>
            <h3 class="fw-normal">&#8369; <%= grandTotal.toFixed(2) %></h3>
          </div>
          <div class="mb-3 mb-4">
           
          <a
            class="btn btn-primary btn-shadow d-block w-100 mt-4"
            href="<% if (cartItems.length > 0) { %>/checkout<% } else { %>/products<% } %>"
            ><i class="ci-card fs-lg me-2"></i>Proceed to Checkout</a
          >
        </div>
      </div>
    </aside>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  function updateCart(){
    var length = <%= cartItems.length %>;
    var ids = [];

    <% cartItems.forEach(function(item, index) { %>
      ids.push('<%= item.id %>');
    <% }); %>

    var isDone = false;

    for (var i = 0; i < length; i++) {
      var quantity = document.getElementById('quantity_' + i).value;
      $.ajax({
        url: '/updateCart',
        type: 'PUT',
        data: {
          product_id: ids[i],
          quantity: quantity
        },
        success: function(data) {
          if(data.status === "success"){
            Swal.fire({
              icon: 'success',
              title: 'Cart updated successfully!',
              showConfirmButton: false,
              timer: 1500
            });
          }
        },
        error: function(err){
          console.log(err);
        }
      });
    }
    setTimeout(() => {
      window.location.reload();
    }, 1500);
  }
</script>
